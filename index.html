<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Generator</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0b0f17;
      color: #fff;
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      box-sizing: border-box;
    }

    .card {
      background: #121826;
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      box-sizing: border-box;
    }

    h1 {
      margin: 0 0 12px 0;
      font-size: 22px;
      line-height: 1.2;
    }

    /* Consistent vertical rhythm */
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 14px;
    }

    label {
      font-size: 12px;
      font-weight: 500;
      color: rgba(255,255,255,.7);
      margin: 0;
    }

    input,
    select {
      width: 100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      background: #fff;
      color: #000;
      box-sizing: border-box;
    }

    /* Hint spacing */
    .hint {
      font-size: 12px;
      color: rgba(255,255,255,.65);
      line-height: 1.4;
      margin-top: 2px;
    }

    /* Buttons grouped + aligned */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
    }

    button {
      width: 100%;
      height: 44px;
      padding: 0 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      cursor: pointer;
      box-sizing: border-box;
    }

    button.primary {
      background: #6366f1;
      color: #fff;
    }

    button.secondary {
      background: #1f2937;
      color: #fff;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #qr {
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }

    /* Ensure the QR canvas/image never overflows */
    #qr canvas,
    #qr img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>QR Code Generator</h1>

    <div class="field">
      <input id="text" placeholder="Enter a URL or text" />
    </div>

    <div class="field">
      <label for="ecLevel">Error correction</label>
      <select id="ecLevel">
        <option value="auto" selected>Auto (recommended)</option>
        <option value="M">M (balanced)</option>
        <option value="Q">Q (more robust)</option>
        <option value="H">H (most robust)</option>
      </select>
      <div class="hint" id="ecHint"></div>
    </div>

    <div class="field">
      <label for="fileType">Download format</label>
      <select id="fileType">
        <option value="png" selected>PNG (recommended)</option>
        <option value="jpeg">JPEG</option>
        <option value="webp">WEBP</option>
      </select>
    </div>

    <div class="actions">
      <button class="primary" id="generate">Generate</button>
      <button class="secondary" id="download" disabled>Download</button>
    </div>

    <div id="qr"></div>
  </div>

  <!-- QRCode global (qrcodejs) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    // DOM refs
    const input = document.getElementById("text");
    const qrBox = document.getElementById("qr");
    const genBtn = document.getElementById("generate");
    const dlBtn = document.getElementById("download");
    const ecSelect = document.getElementById("ecLevel");
    const fileTypeSelect = document.getElementById("fileType");
    const ecHint = document.getElementById("ecHint");

    // qrcodejs correction levels
    const EC = {
      M: QRCode.CorrectLevel.M,
      Q: QRCode.CorrectLevel.Q,
      H: QRCode.CorrectLevel.H
    };

    // Strength ordering for "auto-upgrade"
    const EC_ORDER = ["M", "Q", "H"];
    function maxEC(a, b) {
      return EC_ORDER.indexOf(a) >= EC_ORDER.indexOf(b) ? a : b;
    }

    function looksLikeBareDomain(s) {
      return (
        /^[^\s]+$/.test(s) &&
        s.includes(".") &&
        !/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(s)
      );
    }

    function normalizeValue(raw) {
      let v = String(raw ?? "").trim();
      if (looksLikeBareDomain(v)) v = "https://" + v;
      v = v.replace(/\r\n/g, "\n");
      return v;
    }

    // Defaults: reliable across URLs & longer links
    function autoECForLength(len) {
      if (len > 200) return "H";
      if (len > 100) return "Q";
      return "M";
    }

    function sizeForLength(len) {
      if (len > 200) return 512;
      if (len > 100) return 384;
      return 256;
    }

    function effectiveEC(userChoice, len) {
      const auto = autoECForLength(len);
      if (userChoice === "auto") return auto;
      // User sets minimum; we may upgrade for long strings
      return maxEC(userChoice, auto);
    }

    function updateHint() {
      const value = normalizeValue(input.value);
      const len = value.length;
      const choice = ecSelect.value;
      const ecKey = effectiveEC(choice, len);
      const size = sizeForLength(len);

      const ecLabel =
        ecKey === "M" ? "M (balanced)" :
        ecKey === "Q" ? "Q (more robust)" :
        "H (most robust)";

      const mode =
        choice === "auto"
          ? "Auto is selecting"
          : "Your selection (with auto-upgrades) is using";

      ecHint.textContent =
        `${mode}: ${ecLabel}. QR size: ${size}px` + (len ? ` (input length: ${len})` : "") + `.`;
    }

    function setDownloadButtonText() {
      const type = fileTypeSelect.value;
      const ext = type === "jpeg" ? "JPG" : type.toUpperCase();
      dlBtn.textContent = `Download ${ext}`;
    }

    function generate() {
      const value = normalizeValue(input.value);

      qrBox.innerHTML = "";
      dlBtn.disabled = true;

      if (!value) {
        updateHint();
        return;
      }

      const len = value.length;
      const size = sizeForLength(len);
      const ecKey = effectiveEC(ecSelect.value, len);

      new QRCode(qrBox, {
        text: value,
        width: size,
        height: size,
        correctLevel: EC[ecKey]
      });

      dlBtn.disabled = false;
      setDownloadButtonText();
      updateHint();
    }

    function canvasToDataUrl(canvas, type) {
      if (type === "png") {
        return canvas.toDataURL("image/png");
      }

      // JPEG/WEBP: draw on white background
      const bg = document.createElement("canvas");
      bg.width = canvas.width;
      bg.height = canvas.height;

      const ctx = bg.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, bg.width, bg.height);
      ctx.drawImage(canvas, 0, 0);

      if (type === "jpeg") return bg.toDataURL("image/jpeg", 0.92);
      if (type === "webp") return bg.toDataURL("image/webp", 0.92);

      return canvas.toDataURL("image/png");
    }

    function downloadQr() {
      const type = fileTypeSelect.value;
      const canvas = qrBox.querySelector("canvas");
      const img = qrBox.querySelector("img");

      if (!canvas && !img) return;

      let dataUrl;
      if (canvas) {
        dataUrl = canvasToDataUrl(canvas, type);
      } else {
        // If qrcodejs rendered an <img>, it will usually be PNG data URL already.
        // We'll still download it with the chosen extension.
        dataUrl = img.src;
      }

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = `qr.${type === "jpeg" ? "jpg" : type}`;
      a.click();
    }

    // Events
    genBtn.addEventListener("click", generate);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") generate(); });
    input.addEventListener("input", updateHint);

    ecSelect.addEventListener("change", () => {
      updateHint();
      // re-generate live if a QR already exists
      if (!dlBtn.disabled) generate();
    });

    fileTypeSelect.addEventListener("change", () => {
      setDownloadButtonText();
    });

    dlBtn.addEventListener("click", downloadQr);

    // init
    setDownloadButtonText();
    updateHint();
  </script>
</body>
</html>
